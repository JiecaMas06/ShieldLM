# 内存分配失败 - 快速解决指南

## ❌ 错误

```
RuntimeError: Allocate memory failed
node: output_layer.weight
size: 3111649280
```

## 🎯 原因

使用 `--use_training_conversion` 时，峰值内存达 **120GB+**：

```
训练模型 (28GB) + 权重副本 (56GB) + 推理模型 (28GB) + 运行时 (10GB) = 122GB ❌
```

## ✅ 解决（已自动修复）

**脚本已更新，自动释放内存！**

```bash
# 直接使用，无需额外操作
python ShieldLM/test_qwen3_direct.py \
    --config your_config.yaml \
    --model_dir /path/to/Qwen3-14B \
    --use_training_conversion
```

**优化效果**：

| 项目 | 优化前 | 优化后 | 节省 |
|------|--------|--------|------|
| 峰值内存 | 122GB | **60GB** | -62GB |

## 📊 预期输出

成功时会看到：

```
✓ 训练模型已释放（~28GB）
✓ 中间权重数据已释放
✓ 推理模型权重加载成功
✓ 权重参数已释放（已加载到模型）

============================================================
测试 infer 接口
============================================================
✓ infer调用成功  ← 不再出现内存错误
```

## 🔧 如果仍然不足

### 1. 检查设备内存

```bash
# Ascend
npu-smi info | grep Memory

# 需要至少 50GB 可用
```

### 2. 减少生成长度

```bash
python ShieldLM/test_qwen3_direct.py \
    --config your_config.yaml \
    --model_dir your_weights \
    --use_training_conversion \
    --max_new_tokens 20
```

### 3. 设备推荐

| 设备 | 内存 | 状态 |
|------|------|------|
| **Ascend 910B** | 64GB | ✅ 推荐 |
| **A100-80GB** | 80GB | ✅ 推荐 |
| Ascend 910A | 32GB | ❌ 不足 |
| A100-40GB | 40GB | ⚠️ 勉强 |

## 📖 详细文档

查看 `MEMORY_ISSUE_SOLUTION.md` 了解：
- 完整内存分析
- 技术细节
- 故障排查步骤

