# Qwen3-14B å¸¸è§é—®é¢˜å¿«é€Ÿè§£å†³æŒ‡å—

## ğŸš€ æ¨èä½¿ç”¨å‘½ä»¤

```bash
# ä¸€æ¬¡æ€§è§£å†³æ‰€æœ‰å·²çŸ¥é—®é¢˜
python ShieldLM/test_qwen3_direct.py \
    --config your_config.yaml \
    --model_dir /path/to/Qwen3-14B \
    --tokenizer_path /path/to/Qwen3-14B \
    --use_training_conversion \
    --test_mode both
```

**å‰ææ¡ä»¶**ï¼š
- âœ… æƒé‡ç›®å½•åŒ…å« `config.json` æ–‡ä»¶
- âœ… ä½¿ç”¨ conda ç¯å¢ƒ `el-lorp-min`

---

## é—®é¢˜ 1: æƒé‡è½¬æ¢é”™è¯¯

### é”™è¯¯ä¿¡æ¯
```
RuntimeError: InferenceQwen3ForCausalLM does not implemented convert_weight_dict method.
```

### åŸå› 
æ¨ç†æ¨¡å‹ç¼ºå°‘æƒé‡è½¬æ¢æ–¹æ³•ï¼Œæ— æ³•å¤„ç† HuggingFace æ ¼å¼æƒé‡ã€‚

### è§£å†³æ–¹æ¡ˆ
æ·»åŠ  `--use_training_conversion` å‚æ•°ï¼š

```bash
python ShieldLM/test_qwen3_direct.py \
    --config your_config.yaml \
    --model_dir your_weights \
    --use_training_conversion  # â­ å…³é”®å‚æ•°
```

### è¯¦ç»†æ–‡æ¡£
- `WEIGHT_CONVERSION_ISSUE.md` - æ·±åº¦æŠ€æœ¯åˆ†æ
- `æƒé‡è½¬æ¢é—®é¢˜-å¿«é€Ÿè§£å†³.md` - å¿«é€ŸæŒ‡å—

---

## é—®é¢˜ 2: numpy æ•°ç»„è½¬æ¢é”™è¯¯â­â­

### é”™è¯¯ä¿¡æ¯
```
TypeError: For 'parameter_dict', the element in the argument 'parameter_dict' 
should be a 'str' and 'Parameter', but got <class 'str'> and <class 'numpy.ndarray'>.
```

### åŸå› 
`convert_weight_dict()` è¿”å›çš„æ˜¯ numpy æ•°ç»„ï¼Œä½† `load_param_into_net()` éœ€è¦ Parameter å¯¹è±¡ã€‚

### è§£å†³æ–¹æ¡ˆ
**ä½¿ç”¨æ›´æ–°åçš„è„šæœ¬ï¼ˆå·²è‡ªåŠ¨ä¿®å¤ï¼‰**ï¼š

```bash
# è„šæœ¬å·²ç»è‡ªåŠ¨å¤„ç† numpy â†’ Parameter è½¬æ¢
python ShieldLM/test_qwen3_direct.py \
    --config your_config.yaml \
    --model_dir /path/to/Qwen3-14B \
    --use_training_conversion
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. âœ… è°ƒç”¨ `convert_weight_dict()` è½¬æ¢æƒé‡
2. âœ… å°† numpy æ•°ç»„è½¬æ¢ä¸º Parameter å¯¹è±¡
3. âœ… åŠ è½½åˆ°æ¨¡å‹

**é¢„æœŸè¾“å‡º**ï¼š
```
âœ“ è®­ç»ƒæ¨¡å‹è½¬æ¢æƒé‡å®Œæˆ
è½¬æ¢ numpy æ•°ç»„ä¸º Parameter å¯¹è±¡...
âœ“ è½¬æ¢äº† 443 ä¸ªå‚æ•°
âœ“ æ‰€æœ‰æƒé‡åŠ è½½æˆåŠŸ
```

**è¯¦ç»†è¯´æ˜**ï¼šæŸ¥çœ‹ `NUMPY_TO_PARAMETER_FIX.md`

---

## é—®é¢˜ 3: é…ç½®ä¸åŒ¹é…ï¼ˆæœ€å¸¸è§ï¼‰â­

### é”™è¯¯ä¿¡æ¯
```
RuntimeError: For 'load_param_into_net', embedding.word_embeddings.weight 
shape mismatch. Got shape (151936, 4096) in net and shape (151936, 5120) 
in parameter_dict.
```

### åŸå› 
é…ç½®æ–‡ä»¶çš„ `hidden_size=4096`ï¼Œä½†æƒé‡æ–‡ä»¶æ˜¯ `hidden_size=5120`ã€‚

### è§£å†³æ–¹æ¡ˆï¼ˆä¸‰é€‰ä¸€ï¼‰

#### æ–¹æ¡ˆ A: è‡ªåŠ¨ä¿®å¤ï¼ˆæ¨èï¼‰â­â­â­

**ç¡®ä¿æƒé‡ç›®å½•æœ‰ config.json**ï¼š

```bash
# 1. æ£€æŸ¥æ˜¯å¦æœ‰ config.json
ls /path/to/Qwen3-14B/config.json

# 2. å¦‚æœå­˜åœ¨ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨ä½¿ç”¨å®ƒ
python ShieldLM/test_qwen3_direct.py \
    --config your_config.yaml \
    --model_dir /path/to/Qwen3-14B \
    --use_training_conversion
```

è„šæœ¬ä¼šè¾“å‡ºï¼š
```
âœ“ æ‰¾åˆ° config.json
âœ“ ä»æƒé‡ç›®å½•çš„ config.json åŠ è½½é…ç½®æˆåŠŸ
æ¨¡å‹é…ç½®:
  - hidden_size: 5120  â† è‡ªåŠ¨ä½¿ç”¨æ­£ç¡®å€¼
```

#### æ–¹æ¡ˆ B: æ‰‹åŠ¨ä¿®æ”¹ YAML

ç¼–è¾‘æ‚¨çš„ YAML é…ç½®æ–‡ä»¶ï¼š

```yaml
model:
  model_config:
    type: Qwen3Config
    hidden_size: 5120          # æ”¹ä¸º 5120
    num_hidden_layers: 48      # æ”¹ä¸º 48
    num_attention_heads: 40    # æ”¹ä¸º 40
    num_key_value_heads: 8     # æ”¹ä¸º 8
    intermediate_size: 13824   # æ”¹ä¸º 13824
```

#### æ–¹æ¡ˆ C: åˆ›å»º config.json

å¦‚æœæƒé‡ç›®å½•æ²¡æœ‰ `config.json`ï¼Œæ‰‹åŠ¨åˆ›å»ºï¼š

```bash
cat > /path/to/Qwen3-14B/config.json << 'EOF'
{
  "hidden_size": 5120,
  "num_hidden_layers": 48,
  "num_attention_heads": 40,
  "num_key_value_heads": 8,
  "intermediate_size": 13824,
  "vocab_size": 151936,
  "max_position_embeddings": 32768,
  "model_type": "qwen2",
  "attention_bias": true,
  "rope_theta": 1000000.0,
  "rms_norm_eps": 1e-06
}
EOF
```

### è¯¦ç»†æ–‡æ¡£
`CONFIG_MISMATCH_SOLUTION.md` - å®Œæ•´è§£å†³æ–¹æ¡ˆ

---

## é—®é¢˜ 3: æ‰¾ä¸åˆ° qwen3 æ¨¡å—

### é”™è¯¯ä¿¡æ¯
```
ImportError: cannot import name 'Qwen3ForCausalLM'
```

### è§£å†³æ–¹æ¡ˆ

#### æ­¥éª¤ 1: éªŒè¯ç¯å¢ƒ
```bash
python ShieldLM/verify_qwen3_support.py
```

#### æ­¥éª¤ 2: å¦‚æœéªŒè¯å¤±è´¥
```bash
# å¯èƒ½éœ€è¦ä»æºç å®‰è£… mindformers
cd /path/to/mindformers
pip install -e .
```

### è¯¦ç»†æ–‡æ¡£
`verify_qwen3_support.py` - ç¯å¢ƒéªŒè¯è„šæœ¬

---

## é—®é¢˜ 4: æƒé‡å…¨ä¸ºé›¶

### ç—‡çŠ¶
```
âš ï¸ å‘ç° 443 ä¸ªå…¨é›¶å‚æ•°ï¼ˆå¯èƒ½æœªæ­£ç¡®åŠ è½½ï¼‰
```

### å¯èƒ½åŸå› 
1. checkpoint æ–‡ä»¶è·¯å¾„é”™è¯¯
2. checkpoint æ–‡ä»¶æŸå
3. ä½¿ç”¨äº†é”™è¯¯çš„æƒé‡æ ¼å¼

### è§£å†³æ–¹æ¡ˆ

#### æ£€æŸ¥æƒé‡æ–‡ä»¶
```bash
# 1. ç¡®è®¤æ–‡ä»¶å­˜åœ¨
ls -lh /path/to/weights/*.safetensors

# 2. æ£€æŸ¥æ–‡ä»¶å¤§å°
du -sh /path/to/weights/
# Qwen3-14B åº”è¯¥çº¦ 28GBï¼ˆBF16ï¼‰

# 3. éªŒè¯æƒé‡ç›®å½•ç»“æ„
ls /path/to/weights/
# åº”è¯¥çœ‹åˆ°:
# config.json
# tokenizer.json
# model-*.safetensors æˆ– *.ckpt
```

#### ä½¿ç”¨æ­£ç¡®çš„å‚æ•°
```bash
python ShieldLM/test_qwen3_direct.py \
    --config your_config.yaml \
    --model_dir /path/to/weights \  # ç¡®ä¿è·¯å¾„æ­£ç¡®
    --use_training_conversion
```

---

## é—®é¢˜ 5: æ¨ç†æ—¶å†…å­˜åˆ†é…å¤±è´¥ â­â­â­

### é”™è¯¯ä¿¡æ¯
```
RuntimeError: Allocate memory failed
kernel tensor: shape:(151936, 5120) type:Float32
size: 3111649280
node: output_layer.weight
```

### å‘ç”Ÿæƒ…å†µ
- âœ… æƒé‡åŠ è½½æˆåŠŸï¼ˆ323ä¸ªå‚æ•°ï¼‰
- âœ… æ²¡æœ‰å…¨é›¶å‚æ•°
- âŒ **æ¨ç†æ—¶å†…å­˜åˆ†é…å¤±è´¥**

### åŸå› 
ä½¿ç”¨ `--use_training_conversion` æ—¶ï¼Œå¦‚æœä¸é‡Šæ”¾ä¸­é—´å¯¹è±¡ï¼Œå³°å€¼å†…å­˜å¯è¾¾ **120GB+**ï¼š

```
è®­ç»ƒæ¨¡å‹:   28GB
åŸå§‹æƒé‡:   28GB
è½¬æ¢æƒé‡:   28GB
æ¨ç†æ¨¡å‹:   28GB
æ¨ç†è¿è¡Œ:   10-20GB
-----------------
å³°å€¼æ€»è®¡:   112-122GB âŒ
```

### è§£å†³æ–¹æ¡ˆï¼ˆå·²è‡ªåŠ¨ä¿®å¤ï¼‰âœ…

**è„šæœ¬å·²æ›´æ–°**ï¼Œè‡ªåŠ¨åœ¨å…³é”®ä½ç½®é‡Šæ”¾å†…å­˜ï¼š

```bash
# ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€é¢å¤–æ“ä½œ
python ShieldLM/test_qwen3_direct.py \
    --config your_config.yaml \
    --model_dir /path/to/Qwen3-14B \
    --use_training_conversion
```

**è‡ªåŠ¨å†…å­˜ä¼˜åŒ–**ï¼š
1. âœ… è½¬æ¢å®Œæˆåé‡Šæ”¾è®­ç»ƒæ¨¡å‹ï¼ˆ-28GBï¼‰
2. âœ… åˆ é™¤åŸå§‹æƒé‡å­—å…¸ï¼ˆ-28GBï¼‰
3. âœ… åŠ è½½åé‡Šæ”¾æƒé‡å‚æ•°ï¼ˆ-28GBï¼‰
4. âœ… å³°å€¼å†…å­˜: 120GB â†’ **60GB**

**é¢„æœŸè¾“å‡º**ï¼š
```
âœ“ è®­ç»ƒæ¨¡å‹å·²é‡Šæ”¾ï¼ˆ~28GBï¼‰
âœ“ ä¸­é—´æƒé‡æ•°æ®å·²é‡Šæ”¾
âœ“ æ¨ç†æ¨¡å‹æƒé‡åŠ è½½æˆåŠŸ
âœ“ æƒé‡å‚æ•°å·²é‡Šæ”¾ï¼ˆå·²åŠ è½½åˆ°æ¨¡å‹ï¼‰
```

### å†…å­˜ä¼˜åŒ–æ•ˆæœ

| é˜¶æ®µ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | èŠ‚çœ |
|------|--------|--------|------|
| æƒé‡è½¬æ¢ | 84GB | 56GB | -28GB |
| æ¨ç†æ¨¡å‹åˆ›å»º | 112GB | 56GB | -56GB |
| æ¨ç†è¿è¡Œ | 122GB+ | 60-70GB | -52-62GB |

### å¦‚æœä»ç„¶å†…å­˜ä¸è¶³

1. **æ£€æŸ¥è®¾å¤‡å†…å­˜**ï¼š
   ```bash
   # Ascend NPU
   npu-smi info
   
   # éœ€è¦è‡³å°‘ 50GB å¯ç”¨å†…å­˜
   ```

2. **å‡å°‘ç”Ÿæˆé•¿åº¦**ï¼š
   ```bash
   python ShieldLM/test_qwen3_direct.py \
       --config your_config.yaml \
       --model_dir your_weights \
       --use_training_conversion \
       --max_new_tokens 20  # å‡å°‘ç”Ÿæˆé•¿åº¦
   ```

3. **è®¾å¤‡æ¨è**ï¼š
   - **Ascend 910B (64GB)** âœ… æ¨è
   - **A100-80GB** âœ… æ¨è
   - Ascend 910A (32GB) âŒ ä¸è¶³
   - A100-40GB âš ï¸ å‹‰å¼º

**è¯¦ç»†è¯´æ˜**ï¼šæŸ¥çœ‹ `MEMORY_ISSUE_SOLUTION.md`

---

## é—®é¢˜ 6: å†…å­˜ä¸è¶³ï¼ˆæ—§ç‰ˆæœ¬/ä¸ä½¿ç”¨è®­ç»ƒè½¬æ¢ï¼‰

### é”™è¯¯ä¿¡æ¯
```
OOM (Out of Memory)
æˆ–è€…è¿›ç¨‹è¢« killed
```

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ A: ä¸ä½¿ç”¨è®­ç»ƒæ¨¡å‹è½¬æ¢
```bash
# ç§»é™¤ --use_training_conversion å‚æ•°
python ShieldLM/test_qwen3_direct.py \
    --config your_config.yaml \
    --model_dir your_weights
```

è¿™ä¼šä½¿ç”¨æ›´å°‘å†…å­˜ï¼Œä½†å¯èƒ½éœ€è¦æ‰‹åŠ¨ç¡®ä¿é…ç½®æ­£ç¡®ã€‚

#### æ–¹æ¡ˆ B: å‡å°‘ batch size
```bash
python ShieldLM/test_qwen3_direct.py \
    --config your_config.yaml \
    --model_dir your_weights \
    --batch_size 1  # å‡å° batch size
```

#### æ–¹æ¡ˆ C: ä½¿ç”¨æ›´å¤§å†…å­˜çš„æœºå™¨
Qwen3-14B (BF16) æ¨ç†å¤§çº¦éœ€è¦ï¼š
- ä¸ä½¿ç”¨ `--use_training_conversion`: ~30GB
- ä½¿ç”¨ `--use_training_conversion`: ~50GB

---

## å®Œæ•´æ£€æŸ¥æ¸…å•

åœ¨è¿è¡Œå‰ï¼Œç¡®ä¿ï¼š

- [ ] æƒé‡ç›®å½•åŒ…å« `config.json`
- [ ] æƒé‡æ–‡ä»¶å®Œæ•´ï¼ˆçº¦ 28GB for 14B BF16ï¼‰
- [ ] åˆ†è¯å™¨æ–‡ä»¶å­˜åœ¨ï¼ˆtokenizer.jsonï¼‰
- [ ] ä½¿ç”¨æ­£ç¡®çš„ conda ç¯å¢ƒï¼ˆel-lorp-minï¼‰
- [ ] æœ‰è¶³å¤Ÿçš„å†…å­˜ï¼ˆè‡³å°‘ 50GBï¼‰
- [ ] ä½¿ç”¨ `--use_training_conversion` å‚æ•°

---

## æ¨èçš„å®Œæ•´å‘½ä»¤

```bash
#!/bin/bash

# æ¿€æ´»ç¯å¢ƒ
conda activate el-lorp-min

# è®¾ç½®è·¯å¾„
CONFIG_PATH="/path/to/predict_qwen3_14b.yaml"
MODEL_DIR="/path/to/Qwen3-14B"

# éªŒè¯ç¯å¢ƒï¼ˆå¯é€‰ï¼‰
python ShieldLM/verify_qwen3_support.py

# è¿è¡Œæµ‹è¯•
python ShieldLM/test_qwen3_direct.py \
    --config ${CONFIG_PATH} \
    --model_dir ${MODEL_DIR} \
    --tokenizer_path ${MODEL_DIR} \
    --use_training_conversion \
    --test_mode both \
    --max_new_tokens 50

# æ£€æŸ¥è¾“å‡º
# åº”è¯¥çœ‹åˆ°ï¼š
# âœ“ ä»æƒé‡ç›®å½•çš„ config.json åŠ è½½é…ç½®æˆåŠŸ
# âœ“ è®­ç»ƒæ¨¡å‹è½¬æ¢æƒé‡å®Œæˆ
# âœ“ æ¨ç†æ¨¡å‹æƒé‡åŠ è½½æˆåŠŸ
# âœ“ æ²¡æœ‰å‘ç°å…¨é›¶å‚æ•°
# âœ“ æƒé‡åŠ è½½çœ‹èµ·æ¥æ­£å¸¸
```

---

## å¸¸è§ Qwen3 æ¨¡å‹é…ç½®å‚è€ƒ

| æ¨¡å‹ | hidden_size | num_layers | æƒé‡å¤§å°(BF16) |
|------|-------------|------------|---------------|
| Qwen3-0.5B | 896 | 24 | ~1GB |
| Qwen3-1.8B | 2048 | 28 | ~4GB |
| Qwen3-4B | 2560 | 40 | ~8GB |
| Qwen3-7B | 3584 | 28 | ~14GB |
| **Qwen3-14B** | **5120** | **48** | **~28GB** |
| Qwen3-32B | 5120 | 64 | ~64GB |

---

## è·å–å¸®åŠ©

å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½æ— æ³•è§£å†³é—®é¢˜ï¼š

1. **æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£**ï¼š
   - `QUICKSTART_qwen3_direct.md` - å¿«é€Ÿå¼€å§‹
   - `README_qwen3_direct.md` - å®Œæ•´æ–‡æ¡£
   - `CONFIG_MISMATCH_SOLUTION.md` - é…ç½®é—®é¢˜
   - `WEIGHT_CONVERSION_ISSUE.md` - è½¬æ¢é—®é¢˜

2. **æ£€æŸ¥è„šæœ¬è¾“å‡º**ï¼š
   æ³¨æ„æ‰€æœ‰å¸¦ âš ï¸ å’Œ âŒ çš„è¡Œ

3. **æä¾›è¯Šæ–­ä¿¡æ¯**ï¼š
   - å®Œæ•´çš„é”™è¯¯å †æ ˆ
   - æƒé‡ç›®å½•ç»“æ„ï¼ˆ`ls -lh /path/to/weights/`ï¼‰
   - config.json å†…å®¹
   - mindformers ç‰ˆæœ¬

---

## æˆåŠŸæ ‡å¿—

è¿è¡ŒæˆåŠŸæ—¶ä¼šçœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼š

```
============================================================
âœ“ ä»æƒé‡ç›®å½•çš„ config.json åŠ è½½é…ç½®æˆåŠŸ

æ¨¡å‹é…ç½®:
  - hidden_size: 5120
  - num_hidden_layers: 48
  ...

âœ“ è®­ç»ƒæ¨¡å‹è½¬æ¢æƒé‡å®Œæˆ
âœ“ æ¨ç†æ¨¡å‹åˆ›å»ºæˆåŠŸ
âœ“ æ¨ç†æ¨¡å‹æƒé‡åŠ è½½æˆåŠŸ

============================================================
éªŒè¯æ¨¡å‹æƒé‡
============================================================
âœ“ æ€»å…±æ£€æŸ¥äº† 443 ä¸ªå‚æ•°
âœ“ æ²¡æœ‰å‘ç°å…¨é›¶å‚æ•°
âœ“ æ²¡æœ‰å‘ç°NaN/Infå‚æ•°
âœ“ æƒé‡åŠ è½½çœ‹èµ·æ¥æ­£å¸¸

============================================================
æµ‹è¯• generate æ¥å£
============================================================
âœ“ generateè°ƒç”¨æˆåŠŸ

------------------------------------------------------------
ç”Ÿæˆç»“æœ:
------------------------------------------------------------
ä½ å¥½ï¼æˆ‘æ˜¯é€šä¹‰åƒé—®ï¼Œç”±é˜¿é‡Œäº‘å¼€å‘...
------------------------------------------------------------
```

æ­å–œï¼æ‚¨å·²æˆåŠŸåŠ è½½å’Œè¿è¡Œ Qwen3-14B æ¨¡å‹ï¼ğŸ‰

