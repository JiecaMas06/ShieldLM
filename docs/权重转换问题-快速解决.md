# ⚠️ 权重转换错误 - 快速解决方案

## 错误信息

```
RuntimeError: InferenceQwen3ForCausalLM does not implemented convert_weight_dict method.
```

## 一句话解决

在命令中添加 `--use_training_conversion` 参数：

```bash
python ShieldLM/test_qwen3_direct.py \
    --config your_config.yaml \
    --model_dir your_weights \
    --use_training_conversion  # ⭐ 添加这个！
```

## 为什么会这样？

**简单来说**：
- 推理模型（`InferenceQwen3ForCausalLM`）**没有**权重转换方法
- 训练模型（`TrainingQwen3ForCausalLM`）**有**权重转换方法
- `--use_training_conversion` 会先用训练模型转换权重，再加载到推理模型

**技术细节**：查看 `WEIGHT_CONVERSION_ISSUE.md`

## 完整示例

```bash
# 1. 确认环境
conda activate el-lorp-min

# 2. 运行测试（添加 --use_training_conversion）
python ShieldLM/test_qwen3_direct.py \
    --config /path/to/predict_qwen3_14b.yaml \
    --model_dir /path/to/Qwen3-14B-safetensors \
    --tokenizer_path /path/to/Qwen3-14B-safetensors \
    --use_training_conversion \
    --test_mode both

# 3. 验证输出
# 应该看到：
#   ✓ 训练模型转换权重完成
#   ✓ 推理模型创建成功
#   ✓ 推理模型权重加载成功
```

## 预期输出

成功时应该看到：

```
============================================================
加载Qwen3模型
============================================================
✓ 使用训练模型模式进行权重转换
...
✓ 训练模型实例创建成功（用于权重转换）
  - 模型类型: TrainingQwen3ForCausalLM

从目录加载权重: /path/to/weights
找到 8 个 safetensors 文件
  加载: model-00001-of-00008.safetensors
  ...
  检测到 HuggingFace 权重格式，执行名称转换...
  使用训练模型的 convert_weight_dict 方法...
  ✓ 训练模型转换权重完成
  ✓ 所有权重加载成功

创建推理模型...
✓ 推理模型创建成功
  - 模型类型: InferenceQwen3ForCausalLM
  将权重加载到推理模型...
  ✓ 推理模型权重加载成功

✓ 模型设置为评估模式
============================================================
模型加载完成
============================================================
```

## 内存说明

使用 `--use_training_conversion` 会：
- 短暂创建两个模型实例
- 需要约 1.5-2 倍模型大小的内存
- 对于 Qwen3-14B（BF16）：约 40-50GB 内存

**如果内存不足**：
- 脚本会自动回退到简单的名称映射
- 可能需要检查是否有参数未加载的警告

## 其他文档

- **详细分析**：`WEIGHT_CONVERSION_ISSUE.md`
- **快速开始**：`QUICKSTART_qwen3_direct.md`
- **完整文档**：`README_qwen3_direct.md`
- **文件说明**：`新文件说明.md`

