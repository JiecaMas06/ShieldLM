# Qwen3-14B å®Œæ•´é—®é¢˜è§£å†³è·¯å¾„

## ğŸ¯ ç›®æ ‡

æˆåŠŸåŠ è½½ HuggingFace æ ¼å¼çš„ Qwen3-14B æƒé‡åˆ° MindFormersï¼Œå¹¶è¿è¡Œæ¨ç†ã€‚

## ğŸ—ºï¸ é—®é¢˜å‘ç°ä¸è§£å†³æ—¶é—´çº¿

### é—®é¢˜ 1: æƒé‡è½¬æ¢æ–¹æ³•ç¼ºå¤± â­

**é”™è¯¯**ï¼š
```
RuntimeError: InferenceQwen3ForCausalLM does not implemented convert_weight_dict method.
```

**å‘ç°æ—¶é—´**ï¼šé¦–æ¬¡è¿è¡Œ

**æ ¹æœ¬åŸå› **ï¼š
- `InferenceQwen3ForCausalLM` ç»§æ‰¿ `InferModelMixin` â†’ æ²¡æœ‰ `convert_weight_dict()`
- `TrainingQwen3ForCausalLM` ç»§æ‰¿ `TrainModelMixin` â†’ æœ‰å®Œæ•´çš„ `convert_weight_dict()`

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `--use_training_conversion` å‚æ•°

**çŠ¶æ€**ï¼šâœ… å·²è§£å†³

**æ–‡æ¡£**ï¼š`WEIGHT_CONVERSION_ISSUE.md`

---

### é—®é¢˜ 2: é…ç½®ä¸åŒ¹é… â­â­

**é”™è¯¯**ï¼š
```
RuntimeError: embedding.word_embeddings.weight shape mismatch
Got shape (151936, 4096) in net and shape (151936, 5120) in parameter_dict
```

**å‘ç°æ—¶é—´**ï¼šæƒé‡è½¬æ¢å

**æ ¹æœ¬åŸå› **ï¼š
- YAML é…ç½®: `hidden_size=4096`
- æƒé‡æ–‡ä»¶: `hidden_size=5120`

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®ä¿æƒé‡ç›®å½•æœ‰ `config.json`ï¼ˆè„šæœ¬ä¼šè‡ªåŠ¨ä½¿ç”¨ï¼‰
2. æˆ–æ‰‹åŠ¨ä¿®æ”¹ YAML é…ç½®

**çŠ¶æ€**ï¼šâœ… å·²è§£å†³

**æ–‡æ¡£**ï¼š`CONFIG_MISMATCH_SOLUTION.md`

---

### é—®é¢˜ 3: QKV/FFN æƒé‡æœªåˆå¹¶ â­â­â­

**ç—‡çŠ¶**ï¼š
```
âš  ä»¥ä¸‹å‚æ•°æœªåŠ è½½: (
  ['decoder.layers.0.self_attention.linear_qkv.weight',  # æ¨¡å‹æœŸæœ›
   'decoder.layers.0.mlp.linear_fc1.weight'],
  ['decoder.layers.0.self_attention.linear_q.weight',    # æƒé‡æ–‡ä»¶æœ‰
   'decoder.layers.0.self_attention.linear_k.weight',
   'decoder.layers.0.self_attention.linear_v.weight',
   'decoder.layers.0.mlp.gating.weight',
   'decoder.layers.0.mlp.hidden.weight']
)
```

**å‘ç°æ—¶é—´**ï¼šé…ç½®ä¿®å¤å

**æ ¹æœ¬åŸå› **ï¼š
- æ‰‹åŠ¨åç§°è½¬æ¢åªåšäº†æ˜ å°„
- æ²¡æœ‰è¿›è¡Œ QKV (Q+K+V â†’ QKV) å’Œ FFN (gate+up â†’ linear_fc1) åˆå¹¶

**è§£å†³æ–¹æ¡ˆ**ï¼šå¿…é¡»ä½¿ç”¨ `--use_training_conversion`

**çŠ¶æ€**ï¼šâœ… å·²è§£å†³

**æ–‡æ¡£**ï¼š`WEIGHT_CONVERSION_ISSUE.md`

---

### é—®é¢˜ 4: numpy æ•°ç»„ç±»å‹é”™è¯¯ â­â­

**é”™è¯¯**ï¼š
```
TypeError: For 'parameter_dict', the element should be 'str' and 'Parameter', 
but got <class 'str'> and <class 'numpy.ndarray'>.
```

**å‘ç°æ—¶é—´**ï¼šä½¿ç”¨ `--use_training_conversion` å

**æ ¹æœ¬åŸå› **ï¼š
- `load_checkpoint(format='safetensors')` è¿”å› `dict[str, numpy.ndarray]`
- `convert_weight_dict()` è¿”å›ä»ç„¶æ˜¯ `dict[str, numpy.ndarray]`
- `load_param_into_net()` éœ€è¦ `dict[str, Parameter]`

**è§£å†³æ–¹æ¡ˆ**ï¼šåœ¨åŠ è½½å‰å°† numpy æ•°ç»„è½¬æ¢ä¸º Parameter å¯¹è±¡

**çŠ¶æ€**ï¼šâœ… å·²è§£å†³ï¼ˆè„šæœ¬è‡ªåŠ¨å¤„ç†ï¼‰

**æ–‡æ¡£**ï¼š`NUMPY_TO_PARAMETER_FIX.md`

---

## ğŸ“Š è§£å†³æ–¹æ¡ˆæ¼”è¿›

### å°è¯• 1: ç›´æ¥ä½¿ç”¨ AutoModelï¼ˆå¤±è´¥ï¼‰

```python
model = AutoModel.from_pretrained("/path/to/model")
```

**é—®é¢˜**ï¼šè·¯å¾„è¯†åˆ«å¤±è´¥ï¼Œæƒé‡æœªåŠ è½½

---

### å°è¯• 2: æ‰‹åŠ¨åŠ è½½ + åç§°æ˜ å°„ï¼ˆéƒ¨åˆ†æˆåŠŸï¼‰

```python
params_dict = load_checkpoint(file, format='safetensors')
params_dict = manual_convert_weight_names(params_dict, model)
load_param_into_net(model, params_dict)
```

**é—®é¢˜**ï¼š
- âœ… åç§°æ˜ å°„æˆåŠŸ
- âŒ QKV/FFN æœªåˆå¹¶ â†’ å…³é”®å‚æ•°æœªåŠ è½½

---

### å°è¯• 3: ä½¿ç”¨è®­ç»ƒæ¨¡å‹è½¬æ¢ï¼ˆæ¥è¿‘æˆåŠŸï¼‰

```python
training_model = TrainingQwen3ForCausalLM(config)
params_dict = training_model.convert_weight_dict(params_dict)
load_param_into_net(model, params_dict)
```

**é—®é¢˜**ï¼š
- âœ… QKV/FFN åˆå¹¶æˆåŠŸ
- âŒ numpy æ•°ç»„ç±»å‹é”™è¯¯

---

### æœ€ç»ˆæ–¹æ¡ˆ: å®Œæ•´æµç¨‹ï¼ˆæˆåŠŸï¼‰âœ…

```python
# 1. ä»æƒé‡ç›®å½•åŠ è½½é…ç½®
config = Qwen3Config.from_pretrained(model_dir)  # ä½¿ç”¨ config.json

# 2. åˆ›å»ºè®­ç»ƒæ¨¡å‹
os.environ.pop("RUN_MODE", None)
training_model = TrainingQwen3ForCausalLM(config)

# 3. åŠ è½½æƒé‡
params_dict = load_checkpoint(file, format='safetensors')

# 4. é…ç½®éªŒè¯
verify_weight_config_match(params_dict, config)

# 5. æƒé‡è½¬æ¢ï¼ˆQKV/FFN åˆå¹¶ï¼‰
params_dict = training_model.convert_weight_dict(params_dict)

# 6. numpy è½¬ Parameter
final_params = {}
for name, value in params_dict.items():
    if isinstance(value, np.ndarray):
        final_params[name] = Parameter(ms.Tensor(value), name=name, requires_grad=False)

# 7. åˆ›å»ºæ¨ç†æ¨¡å‹
os.environ["RUN_MODE"] = "predict"
model = InferenceQwen3ForCausalLM(config)

# 8. åŠ è½½æƒé‡
load_param_into_net(model, final_params)

# âœ… æˆåŠŸï¼
```

---

## ğŸ“ æ ¸å¿ƒå­¦ä¹ ç‚¹

### 1. MindFormers çš„æƒé‡è½¬æ¢æµç¨‹

æ ¹æ® [MindSpore å®˜æ–¹æ–‡æ¡£](https://www.mindspore.cn/mindformers/docs/zh-CN/r1.7.0/advanced_development/weight_transfer.html)ï¼š

```
HuggingFace safetensors
    â†“
convert_name()           # åç§°è½¬æ¢
    â†“
weight_mapping           # Q/K/V, gate/up åˆ†ç¦»çŠ¶æ€
    â†“
stacked_params_mapping   # QKV/FFN åˆå¹¶
    â†“
weight_loader           # åŠ è½½åˆ°æ¨¡å‹
    â†“
MindFormers æ¨¡å‹
```

### 2. æ¨ç† vs è®­ç»ƒæ¨¡å‹çš„å·®å¼‚

| ç‰¹æ€§ | InferenceQwen3ForCausalLM | TrainingQwen3ForCausalLM |
|------|--------------------------|--------------------------|
| ç»§æ‰¿ | InferModelMixin | TrainModelMixin |
| convert_weight_dict | âŒ æ—  | âœ… å®Œæ•´å®ç° |
| QKV/FFN åˆå¹¶ | âŒ æ—  | âœ… æœ‰ |
| æ¨ç†ä¼˜åŒ– | âœ… MCore ä¼˜åŒ– | âŒ æ ‡å‡†å®ç° |
| ç”¨é€” | æ¨ç† | è®­ç»ƒ + æƒé‡è½¬æ¢ |

### 3. MindSpore æ•°æ®ç±»å‹

```python
# .ckpt æ–‡ä»¶ï¼ˆMindSpore åŸç”Ÿï¼‰
load_checkpoint("model.ckpt")
â†’ dict[str, Parameter]  # ç›´æ¥å¯ç”¨

# .safetensors æ–‡ä»¶ï¼ˆé€šç”¨æ ¼å¼ï¼‰
load_checkpoint("model.safetensors", format='safetensors')
â†’ dict[str, numpy.ndarray]  # éœ€è¦è½¬æ¢ä¸º Parameter
```

---

## ğŸš€ ä¸€é”®è§£å†³å‘½ä»¤

```bash
#!/bin/bash

# å®Œæ•´çš„è§£å†³æ–¹æ¡ˆ
python ShieldLM/test_qwen3_direct.py \
    --config /path/to/predict_qwen3_14b.yaml \
    --model_dir /path/to/Qwen3-14B \  # ç¡®ä¿æœ‰ config.json
    --tokenizer_path /path/to/Qwen3-14B \
    --use_training_conversion \  # â­ å…³é”®ï¼šå®Œæ•´æƒé‡è½¬æ¢
    --test_mode both

# é¢„æœŸè¾“å‡ºï¼š
# âœ“ ä»æƒé‡ç›®å½•çš„ config.json åŠ è½½é…ç½®æˆåŠŸ
# âœ“ æƒé‡ä¸é…ç½®åŒ¹é…
# âœ“ è®­ç»ƒæ¨¡å‹è½¬æ¢æƒé‡å®Œæˆ
# âœ“ è½¬æ¢äº† 443 ä¸ªå‚æ•°
# âœ“ æ‰€æœ‰æƒé‡åŠ è½½æˆåŠŸ
# âœ“ æ²¡æœ‰å‘ç°å…¨é›¶å‚æ•°
# âœ“ æƒé‡åŠ è½½çœ‹èµ·æ¥æ­£å¸¸
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

| é—®é¢˜ | æ–‡æ¡£ |
|------|------|
| æƒé‡è½¬æ¢æ–¹æ³•ç¼ºå¤± | `WEIGHT_CONVERSION_ISSUE.md` |
| é…ç½®ä¸åŒ¹é… | `CONFIG_MISMATCH_SOLUTION.md` |
| numpy æ•°ç»„è½¬æ¢ | `NUMPY_TO_PARAMETER_FIX.md` |
| æ‰€æœ‰é—®é¢˜æ±‡æ€» | `å¸¸è§é—®é¢˜å¿«é€Ÿè§£å†³.md` |
| å¿«é€Ÿå¼€å§‹ | `QUICKSTART_qwen3_direct.md` |
| å®Œæ•´æ–‡æ¡£ | `README_qwen3_direct.md` |

---

## âœ… æˆåŠŸæ ‡å¿—

å½“æ‚¨çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºæ—¶ï¼Œè¯´æ˜æ‰€æœ‰é—®é¢˜éƒ½å·²è§£å†³ï¼š

```
============================================================
éªŒè¯æƒé‡ä¸é…ç½®çš„åŒ¹é…æ€§
============================================================
âœ“ æƒé‡ä¸é…ç½®åŒ¹é…

============================================================
âœ“ è®­ç»ƒæ¨¡å‹è½¬æ¢æƒé‡å®Œæˆ
è½¬æ¢ numpy æ•°ç»„ä¸º Parameter å¯¹è±¡...
âœ“ è½¬æ¢äº† 443 ä¸ªå‚æ•°

ç¡®ä¿å‚æ•°æ ¼å¼æ­£ç¡®...
âœ“ 443 ä¸ªå‚æ•°æ ¼å¼å·²ç¡®è®¤

âœ“ æ‰€æœ‰æƒé‡åŠ è½½æˆåŠŸ
âœ“ safetensors æƒé‡åŠ è½½å®Œæˆ

åˆ›å»ºæ¨ç†æ¨¡å‹...
âœ“ æ¨ç†æ¨¡å‹åˆ›å»ºæˆåŠŸ
  - æ¨¡å‹ç±»å‹: InferenceQwen3ForCausalLM
âœ“ æ¨ç†æ¨¡å‹æƒé‡åŠ è½½æˆåŠŸ

============================================================
éªŒè¯æ¨¡å‹æƒé‡
============================================================
âœ“ æ€»å…±æ£€æŸ¥äº† 443 ä¸ªå‚æ•°
âœ“ æ²¡æœ‰å‘ç°å…¨é›¶å‚æ•°
âœ“ æ²¡æœ‰å‘ç°NaN/Infå‚æ•°
âœ“ æƒé‡åŠ è½½çœ‹èµ·æ¥æ­£å¸¸

============================================================
æµ‹è¯• generate æ¥å£
============================================================
âœ“ generateè°ƒç”¨æˆåŠŸ

ç”Ÿæˆç»“æœ:
ä½ å¥½ï¼æˆ‘æ˜¯é€šä¹‰åƒé—®ï¼Œç”±é˜¿é‡Œäº‘å¼€å‘çš„AIåŠ©æ‰‹...
============================================================
```

æ­å–œï¼æ‚¨å·²æˆåŠŸè§£å†³æ‰€æœ‰é—®é¢˜ï¼ğŸ‰

---

## ğŸ”® æœªæ¥æ”¹è¿›å»ºè®®

### ç»™ MindFormers å›¢é˜Ÿçš„å»ºè®®

1. **InferenceQwen3ForCausalLM æ·»åŠ æƒé‡è½¬æ¢æ”¯æŒ**
   ```python
   # å»ºè®®åœ¨ modeling_qwen3_infer.py ä¸­æ·»åŠ 
   class InferenceQwen3ForCausalLM:
       @classmethod
       def convert_weight_dict(cls, source_dict, **kwargs):
           # å¤ç”¨è®­ç»ƒæ¨¡å‹çš„å®ç°
           from .modeling_qwen3_train import TrainingQwen3ForCausalLM
           return TrainingQwen3ForCausalLM.convert_weight_dict(source_dict, **kwargs)
   ```

2. **safetensors åŠ è½½å™¨è‡ªåŠ¨è½¬æ¢**
   ```python
   # å»ºè®®åœ¨ load_checkpoint ä¸­
   def load_checkpoint(file, format='safetensors'):
       if format == 'safetensors':
           params = _load_safetensors(file)
           # è‡ªåŠ¨è½¬æ¢ä¸º Parameter
           return {k: Parameter(v, name=k) for k, v in params.items()}
   ```

3. **ç»Ÿä¸€çš„æƒé‡è½¬æ¢ API**
   ```python
   # å»ºè®®æä¾›ç»Ÿä¸€æ¥å£
   model = AutoModel.from_pretrained(
       "/path/to/model",
       auto_convert=True  # è‡ªåŠ¨å¤„ç† HF æ ¼å¼
   )
   ```

---

## ğŸ“– å‚è€ƒèµ„æ–™

- [MindSpore Transformers æƒé‡è½¬æ¢å¼€å‘é€‚é…](https://www.mindspore.cn/mindformers/docs/zh-CN/r1.7.0/advanced_development/weight_transfer.html)
- æœ¬é¡¹ç›®åˆ›å»ºçš„æ‰€æœ‰æ–‡æ¡£ï¼ˆè§ä¸Šè¡¨ï¼‰

---

**ä» 4 ä¸ªé—®é¢˜åˆ°å®Œå…¨è§£å†³ï¼Œè¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„è°ƒè¯•å’Œè§£å†³è¿‡ç¨‹ï¼** ğŸŠ

