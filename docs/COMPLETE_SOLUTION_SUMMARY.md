# å®Œæ•´è§£å†³æ–¹æ¡ˆæ€»ç»“

## ğŸ¯ é—®é¢˜å›é¡¾

**åˆå§‹ç—‡çŠ¶ï¼š**
- `generate` åªç”Ÿæˆ "!!!!!..." (token ID 0)
- `infer` æ‰€æœ‰æ¦‚ç‡éƒ½ä¸º 0
- ä½¿ç”¨ `run_mindformers.py` åŒä¸€æ¨¡å‹å¯ä»¥æ­£å¸¸å·¥ä½œ

## ğŸ” è°ƒæŸ¥è¿‡ç¨‹

### ç¬¬1æ­¥ï¼šæ·»åŠ Chat Template âœ…
**å‡è®¾ï¼š** ç¼ºå°‘å¯¹è¯æ ¼å¼å¯¼è‡´è¾“å‡ºå¼‚å¸¸  
**ä¿®å¤ï¼š** æ·»åŠ  `tokenizer.apply_chat_template()` å¤„ç†  
**ç»“æœï¼š** ä»ç„¶å¤±è´¥ï¼Œé—®é¢˜æ›´æ·±å±‚

### ç¬¬2æ­¥ï¼šæ·»åŠ æƒé‡éªŒè¯ âœ…
**å‡è®¾ï¼š** å¯èƒ½æ˜¯æƒé‡åŠ è½½é—®é¢˜  
**è¡ŒåŠ¨ï¼š** æ·»åŠ å…¨é¢çš„æƒé‡éªŒè¯ä»£ç   
**å‘ç°ï¼š** ğŸ”´ **162ä¸ªå‚æ•°å…¨ä¸ºé›¶ï¼**

```
âš ï¸ å‘ç° 162 ä¸ªå…¨é›¶å‚æ•°ï¼ˆå¯èƒ½æœªæ­£ç¡®åŠ è½½ï¼‰:
  - model.embedding.word_embeddings.weight
  - model.decoder.layers.0.self_attention.linear_proj.weight
  - model.decoder.layers.0.self_attention.linear_qkv.weight
  ...

Embeddingå±‚ç‰¹åˆ«æ£€æŸ¥:
  - 'ä½ ' (id=56568): norm=0.000000, mean=0.000000
  - 'å¥½' (id=52801): norm=0.000000, mean=0.000000
  âŒ æ‰€æœ‰embeddingå‘é‡éƒ½æ˜¯é›¶ï¼
```

### ç¬¬3æ­¥ï¼šå‘ç°æ ¹æœ¬åŸå›  ğŸ¯

**é—®é¢˜ä»£ç ï¼š**
```python
model = AutoModel.from_config(args.config_path)  # âŒ åªåˆ›å»ºç»“æ„ï¼
```

**å¯¹æ¯” run_mindformers.pyï¼š**
```python
trainer = Trainer(...)  # å†…éƒ¨ä½¿ç”¨ from_pretrained æˆ–è‡ªåŠ¨åŠ è½½checkpoint
trainer.predict(...)    # âœ… æƒé‡å·²ç»åŠ è½½
```

**æ ¹æœ¬åŸå› ï¼š**  
`AutoModel.from_config()` åªåˆ›å»ºæ¨¡å‹ç»“æ„ï¼Œä½¿ç”¨**éšæœºåˆå§‹åŒ–çš„æƒé‡**ï¼Œæ ¹æœ¬æ²¡æœ‰åŠ è½½safetensorsæ–‡ä»¶ï¼

## âœ… å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¼šæƒé‡åŠ è½½ï¼ˆæœ€å…³é”®ï¼ï¼‰

**ä¿®æ”¹æ–‡ä»¶ï¼š** `test_qwen3_mindformers.py`

**ä¿®æ”¹å‰ï¼š**
```python
model = AutoModel.from_config(args.config_path)
```

**ä¿®æ”¹åï¼š**
```python
if pretrained_dir and os.path.exists(pretrained_dir):
    print(f"  ä½¿ç”¨from_pretrainedåŠ è½½: {pretrained_dir}")
    try:
        # æ¨èæ–¹å¼ï¼šè‡ªåŠ¨åŠ è½½ç»“æ„å’Œæƒé‡
        model = AutoModelForCausalLM.from_pretrained(pretrained_dir)
        print("âœ“ æ¨¡å‹åŠæƒé‡åŠ è½½æˆåŠŸï¼ˆfrom_pretrainedï¼‰")
    except Exception as e:
        # å¤‡ç”¨æ–¹å¼ï¼šæ‰‹åŠ¨åŠ è½½
        model = AutoModel.from_config(args.config_path)
        if hasattr(model, 'load_checkpoint'):
            model.load_checkpoint(cfg.model.model_config)
else:
    # ä»…åˆ›å»ºç»“æ„ï¼ˆæ— æƒé‡ï¼‰
    model = AutoModel.from_config(args.config_path)
```

### ä¿®å¤2ï¼šChat Templateï¼ˆå·²å®Œæˆï¼‰

**ä½ç½®ï¼š** `test_generate()` å’Œ `test_infer()` å‡½æ•°

```python
# åº”ç”¨chat template
messages = [{"role": "user", "content": prompt}]
input_ids = tokenizer.apply_chat_template(
    messages, 
    add_generation_prompt=True,
    return_tensors=None
)
```

### ä¿®å¤3ï¼šæƒé‡éªŒè¯ï¼ˆå·²å®Œæˆï¼‰

æ·»åŠ äº†å…¨é¢çš„éªŒè¯åŠŸèƒ½ï¼š
- âœ… Checkpointæ–‡ä»¶æ£€æŸ¥
- âœ… å‚æ•°å…¨é›¶æ£€æµ‹
- âœ… Embeddingå±‚éªŒè¯
- âœ… å¿«é€Ÿå‰å‘ä¼ æ’­æµ‹è¯•

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰

| é¡¹ç›® | çŠ¶æ€ | ç»“æœ |
|------|------|------|
| æƒé‡åŠ è½½ | âŒ æœªåŠ è½½ï¼ˆ162ä¸ªå‚æ•°å…¨é›¶ï¼‰ | éšæœºè¾“å‡º |
| Chat Template | âŒ ç¼ºå¤± | æ ¼å¼é”™è¯¯ |
| è¾“å‡º | âŒ åªç”Ÿæˆ "!" | æ— æ„ä¹‰ |

### ä¿®å¤åï¼ˆé¢„æœŸï¼‰

| é¡¹ç›® | çŠ¶æ€ | ç»“æœ |
|------|------|------|
| æƒé‡åŠ è½½ | âœ… æ­£ç¡®åŠ è½½ | æ‰€æœ‰å‚æ•°æœ‰å€¼ |
| Chat Template | âœ… å·²æ·»åŠ  | æ ¼å¼æ­£ç¡® |
| è¾“å‡º | âœ… æ­£å¸¸ç”Ÿæˆ | æœ‰æ„ä¹‰çš„ä¸­æ–‡ |

## ğŸ§ª éªŒè¯æ­¥éª¤

### 1. è¿è¡Œæµ‹è¯•

```bash
python test_qwen3_mindformers.py \
    --config models/predict_qwen3.yaml \
    --test_mode both \
    --prompt "ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ã€‚" \
    --max_new_tokens 50
```

### 2. æ£€æŸ¥å…³é”®è¾“å‡º

#### A. æƒé‡åŠ è½½ç¡®è®¤
```
æ­£åœ¨åŠ è½½æ¨¡å‹...
  ä½¿ç”¨from_pretrainedåŠ è½½: ./models/Qwen3-14B
âœ“ æ¨¡å‹åŠæƒé‡åŠ è½½æˆåŠŸï¼ˆfrom_pretrainedï¼‰  â† ç¡®è®¤è¿™è¡Œå‡ºç°
```

#### B. æƒé‡éªŒè¯
```
============================================================
éªŒè¯æ¨¡å‹æƒé‡åŠ è½½
============================================================
âœ“ æ€»å…±æ£€æŸ¥äº† 323 ä¸ªå‚æ•°
âœ“ æ²¡æœ‰å‘ç°å…¨é›¶å‚æ•°  â† ä¿®å¤æˆåŠŸçš„æ ‡å¿—ï¼
âœ“ æ²¡æœ‰å‘ç°NaN/Infå‚æ•°

Embeddingå±‚ç‰¹åˆ«æ£€æŸ¥:
  - 'ä½ ' (id=56568): norm=2.345678, mean=0.000123  â† æœ‰å€¼äº†ï¼
  - 'å¥½' (id=52801): norm=2.234567, mean=-0.000234  â† æœ‰å€¼äº†ï¼

âœ“ æƒé‡åŠ è½½çœ‹èµ·æ¥æ­£å¸¸  â† éªŒè¯é€šè¿‡ï¼
```

#### C. å¿«é€Ÿå‰å‘ä¼ æ’­
```
å¿«é€Ÿå‰å‘ä¼ æ’­æµ‹è¯•
âœ“ å‰å‘ä¼ æ’­æˆåŠŸ
  - è¾“å‡ºç»Ÿè®¡:
    - std: 3.456789  â† ä¸æ˜¯0ï¼
  - Top 5 é¢„æµ‹token:
    Token 198: 0.234567 ('\n')  â† åˆç†çš„æ¦‚ç‡ï¼
    Token 13: 0.123456 ('.')
```

#### D. Generateæµ‹è¯•
```
ç”Ÿæˆç»“æœ:
------------------------------------------------------------
ä½ å¥½ï¼æˆ‘æ˜¯ä¸€ä¸ªäººå·¥æ™ºèƒ½åŠ©æ‰‹ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚æˆ‘å¯ä»¥...
------------------------------------------------------------
^ æ­£å¸¸çš„ä¸­æ–‡å›å¤ï¼Œä¸å†æ˜¯ "!!!" ^
```

#### E. Inferæµ‹è¯•
```
  ğŸ“Š probs ç»Ÿè®¡è¯Šæ–­:
    - max: 0.234567  â† ä¸æ˜¯0ï¼
    - sum: 1.000000  â† æ¦‚ç‡å½’ä¸€åŒ–æ­£ç¡®ï¼
    
  - Top 5 tokens:
    Token 123: 0.234567 ('æˆ‘')
    Token 456: 0.123456 ('æ˜¯')
    Token 789: 0.098765 ('ä½ ')
    ^ åˆç†çš„tokené¢„æµ‹ï¼Œä¸å…¨æ˜¯0 ^
```

## ğŸ”‘ å…³é”®è¦ç‚¹

### 1. APIä½¿ç”¨å·®å¼‚

| åœºæ™¯ | æ­£ç¡®API | é”™è¯¯API |
|------|---------|---------|
| **æ¨ç†/å¾®è°ƒ** | `from_pretrained()` | `from_config()` |
| **ä»å¤´è®­ç»ƒ** | `from_config()` | - |

### 2. ä¸ºä»€ä¹ˆ run_mindformers.py èƒ½å·¥ä½œï¼Ÿ

```python
# run_mindformers.py
trainer = Trainer(task='text_generation', model_name='qwen3_14b')
trainer.predict(...)
```

**å†…éƒ¨æµç¨‹ï¼š**
1. Traineråˆå§‹åŒ–æ—¶åˆ›å»ºæ¨¡å‹ç»“æ„
2. `predict()` è°ƒç”¨å‰è‡ªåŠ¨è®¾ç½® `load_checkpoint` è·¯å¾„
3. åº•å±‚ `trainer.predict()` è‡ªåŠ¨è°ƒç”¨ `load_checkpoint()` + `load_param_into_net()`
4. æƒé‡æ­£ç¡®åŠ è½½ âœ…

### 3. æˆ‘ä»¬ä»£ç çš„é—®é¢˜

```python
# test_qwen3_mindformers.py (åŸå§‹ç‰ˆæœ¬)
model = AutoModel.from_config(args.config_path)  # âŒ åªåˆ›å»ºç»“æ„
# ç¼ºå°‘ï¼šåŠ è½½æƒé‡çš„æ­¥éª¤ï¼
```

**ç»“æœï¼š** æ‰€æœ‰å‚æ•°éƒ½æ˜¯éšæœºåˆå§‹åŒ–çš„0æˆ–æ¥è¿‘0çš„å€¼

### 4. Chat Templateçš„ä½œç”¨

å³ä½¿æƒé‡æ­£ç¡®åŠ è½½ï¼Œå¦‚æœæ²¡æœ‰chat templateï¼š
- è¾“å…¥æ ¼å¼ä¸ç¬¦åˆæ¨¡å‹è®­ç»ƒæ—¶çš„æ ¼å¼
- æ¨¡å‹æ— æ³•æ­£ç¡®ç†è§£æŒ‡ä»¤
- è¾“å‡ºå¯èƒ½ä»ç„¶å¼‚å¸¸

**ä¸¤ä¸ªé—®é¢˜å¿…é¡»åŒæ—¶è§£å†³ï¼š**
1. âœ… æƒé‡åŠ è½½ï¼ˆæœ€æ ¹æœ¬ï¼‰
2. âœ… Chat Templateï¼ˆæ ¼å¼æ­£ç¡®ï¼‰

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. **`WEIGHT_LOADING_FIX.md`** - æƒé‡åŠ è½½é—®é¢˜çš„è¯¦ç»†åˆ†æ
2. **`FINAL_ROOT_CAUSE.md`** - æ ¹æœ¬åŸå› å¿«é€Ÿå‚è€ƒ
3. **`WEIGHT_VERIFICATION_GUIDE.md`** - æƒé‡éªŒè¯ä½¿ç”¨æŒ‡å—
4. **`CHAT_TEMPLATE_FIX.md`** - Chat Templateä¿®å¤è¯´æ˜

## ğŸ‰ é¢„æœŸç»“æœ

ä¿®å¤å®Œæˆåï¼š

âœ… **æƒé‡éªŒè¯ï¼š**
- æ‰€æœ‰å‚æ•°æ­£ç¡®åŠ è½½
- Embeddingå±‚æœ‰å€¼
- å‰å‘ä¼ æ’­æ­£å¸¸

âœ… **GenerateåŠŸèƒ½ï¼š**
- ç”Ÿæˆæœ‰æ„ä¹‰çš„ä¸­æ–‡æ–‡æœ¬
- ä¸å†åªè¾“å‡ºæ„Ÿå¹å·

âœ… **InferåŠŸèƒ½ï¼š**
- è¿”å›åˆç†çš„æ¦‚ç‡åˆ†å¸ƒ
- ä¸å†å…¨ä¸ºé›¶

## ğŸš€ ä¸‹ä¸€æ­¥

1. **è¿è¡Œæµ‹è¯•** - éªŒè¯æ‰€æœ‰ä¿®å¤æ˜¯å¦ç”Ÿæ•ˆ
2. **åˆ†äº«ç»“æœ** - å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œæä¾›ï¼š
   - æƒé‡éªŒè¯çš„å®Œæ•´è¾“å‡º
   - Generateçš„å®é™…è¾“å‡º
   - Inferçš„æ¦‚ç‡ç»Ÿè®¡
   - ä»»ä½•é”™è¯¯ä¿¡æ¯

## ğŸ’¡ æ•™è®­æ€»ç»“

1. **APIé€‰æ‹©å¾ˆé‡è¦**
   - æ¨ç†å¿…é¡»ç”¨ `from_pretrained()`
   - è®­ç»ƒå¯ä»¥ç”¨ `from_config()`

2. **éªŒè¯æ˜¯å¿…è¦çš„**
   - æ·»åŠ æƒé‡éªŒè¯å¸®åŠ©å¿«é€Ÿå®šä½é—®é¢˜
   - ä¸è¦å‡è®¾åŠ è½½æˆåŠŸï¼Œè¦éªŒè¯

3. **å¯¹æ¯”æ˜¯æœ‰æ•ˆçš„**
   - å¯¹æ¯”å·¥ä½œçš„ä»£ç ï¼ˆrun_mindformers.pyï¼‰
   - æ‰¾å‡ºå·®å¼‚ç‚¹

4. **å¤šå±‚æ¬¡é—®é¢˜**
   - æƒé‡åŠ è½½ï¼ˆæ ¹æœ¬ï¼‰
   - Chat Templateï¼ˆæ ¼å¼ï¼‰
   - éƒ½è¦è§£å†³

---

**ç°åœ¨è¿è¡Œæµ‹è¯•ï¼Œä¸€åˆ‡åº”è¯¥éƒ½æ­£å¸¸å·¥ä½œäº†ï¼** ğŸŠ

å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œæä¾›è¯¦ç»†çš„è¾“å‡ºä¿¡æ¯è¿›è¡Œè¿›ä¸€æ­¥è¯Šæ–­ã€‚

